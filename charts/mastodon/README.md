# Mastodon

Mastodon is a free, open-source social network server based on ActivityPub where users can follow friends and discover new ones. On Mastodon, users can publish anything they want: links, pictures, text, video. All Mastodon servers are interoperable as a federated network (users on one server can seamlessly communicate with users from another one, including non-Mastodon software that implements ActivityPub)!

## TL;DR

```console
helm repo add codechem https://charts.codechem.com
helm install mastodon codechem/mastodon --wait
```

> **NOTE**: Using the `--wait` flag is recommended. Helm hooks are used for the order of operations, as well as database migrations which can be slow, so timeout might occur on slower machines, preventing the full deployment of the resources.

## Introduction

Mastodon is free and open-source software for running self-hosted social networking services. It has microblogging features similar to the Twitter service, which are offered by a large number of independently run nodes, known as instances, each with its own code of conduct, terms of service, privacy policy, privacy options, and moderation policies.

Each user is a member of a specific Mastodon instance (also called a server), which can interoperate as a federated social network, allowing users on different instances to interact with each other. This is intended to give users the flexibility to select a node whose policies they prefer, but keep access to a larger social network. Mastodon is also part of the Fediverse ensemble of server platforms, which use shared protocols allowing users to also interact with users on other compatible platforms, such as PeerTube and Friendica. Mastodon is crowdfunded and does not contain ads.

## Prerequisites

- Kubernetes 1.18+
- Helm 3.2.0+

## Installing the Chart

To install the chart with the release name `mastodon`:

```console
helm install mastodon codechem/mastodon
```

The command deploys mastodon on the Kubernetes cluster in the default configuration. The [Parameters](#parameters) section lists the parameters that can be configured during installation.

> **Tip**: List all releases using `helm list`

## Uninstalling the Chart

To uninstall/delete the `mastodon` deployment:

```console
helm delete mastodon
```

The command removes all the Kubernetes components associated with the chart and deletes the release.

## Parameters

### Global parameters

| Name                          | Description                                                                                                                                                                                                                                                                                                                                                                                                                                             | Value  |
| ----------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------ |
| `global.postgresqlEnabled`    | Whether to deploy the Bitnami PostgreSQL chart as subchart. Check [the official chart](https://artifacthub.io/packages/helm/bitnami/postgresql) for configuration.                                                                                                                                                                                                                                                                                      | `true` |
| `global.redisEnabled`         | Whether to deploy the Bitnami Redis chart as subchart. Check [the official chart](https://artifacthub.io/packages/helm/bitnami/redis) for configuration.                                                                                                                                                                                                                                                                                                | `true` |
| `global.elasticsearchEnabled` | Whether to deploy the Bitnami Elasticsearch chart as subchart. Check [the official chart](https://artifacthub.io/packages/helm/bitnami/elasticsearch) for configuration. If you don't have Elasticsearch, full-text search will be disabled. If you enable ES after the initial install, you will need to manually run `RAILS_ENV=production bundle exec rake chewy:sync`. See [the docs](https://docs.joinmastodon.org/admin/optional/elasticsearch/). | `true` |
| `global.imagePullSecrets`     | Global Docker registry secret names as an array.                                                                                                                                                                                                                                                                                                                                                                                                        | `[]`   |


### Common parameters

| Name                         | Description                                                                                                             | Value                |
| ---------------------------- | ----------------------------------------------------------------------------------------------------------------------- | -------------------- |
| `nameOverride`               | String to partially override common.names.fullname                                                                      | `""`                 |
| `fullnameOverride`           | String to fully override common.names.fullname                                                                          | `""`                 |
| `image.repository`           | The Docker repository to pull the image from.                                                                           | `tootsuite/mastodon` |
| `image.tag`                  | The image tag to use.                                                                                                   | `v4.0.2`             |
| `image.imagePullPolicy`      | The image pull policy to use.                                                                                           | `IfNotPresent`       |
| `serviceAccount.enabled`     | Specifies whether a ServiceAccount should be created.                                                                   | `true`               |
| `serviceAccount.annotations` | Annotations for service account. Evaluated as a template. Only used if `create` is `true`.                              | `{}`                 |
| `serviceAccount.name`        | The name of the ServiceAccount to use. If not set and enabled is true, a name is generated using the fullname template. | `""`                 |


### Web parameters

| Name                                                    | Description                                                                                                     | Value       |
| ------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------- | ----------- |
| `web.replicaCount`                                      | The number of replicas to deploy.                                                                               | `1`         |
| `web.service.type`                                      | The service type to create.                                                                                     | `ClusterIP` |
| `web.service.port`                                      | The service port to use.                                                                                        | `3000`      |
| `web.ingress.enabled`                                   | Enable ingress record generation for Mastodon web.                                                              | `false`     |
| `web.ingress.annotations`                               | Mapped annotations for the web ingress.                                                                         | `{}`        |
| `web.ingress.hosts`                                     | Array style hosts for the web ingress.                                                                          | `[]`        |
| `web.ingress.tls`                                       | Array style TLS secrets for the web ingress.                                                                    | `[]`        |
| `web.podSecurityContext.enabled`                        | Enabled Web pods' security context                                                                              | `true`      |
| `web.podSecurityContext.runAsUser`                      | Set Web pod's security context runAsUser                                                                        | `991`       |
| `web.podSecurityContext.runAsGroup`                     | Set Web pod's security context runAsGroup                                                                       | `991`       |
| `web.podSecurityContext.fsGroup`                        | Set Web pod's security context fsGroup                                                                          | `991`       |
| `web.containerSecurityContext.enabled`                  | Enabled Web containers' security context                                                                        | `false`     |
| `web.containerSecurityContext.runAsUser`                | Set Web containers' security context runAsUser                                                                  | `1001`      |
| `web.containerSecurityContext.allowPrivilegeEscalation` | Set Web containers' security context allowPrivilegeEscalation                                                   | `false`     |
| `web.containerSecurityContext.capabilities.drop`        | Set Web containers' security context capabilities to be dropped                                                 | `["all"]`   |
| `web.containerSecurityContext.readOnlyRootFilesystem`   | Set Web containers' security context readOnlyRootFilesystem                                                     | `false`     |
| `web.containerSecurityContext.runAsNonRoot`             | Set Web container's security context runAsNonRoot                                                               | `true`      |
| `web.affinity`                                          | Affinity for Web pods assignment                                                                                | `{}`        |
| `web.nodeSelector`                                      | Node labels for Web pods assignment                                                                             | `{}`        |
| `web.tolerations`                                       | Tolerations for Web pods assignment                                                                             | `[]`        |
| `web.resources.limits`                                  | The resources limits for the web containers                                                                     | `{}`        |
| `web.resources.requests`                                | The requested resources for the web containers                                                                  | `{}`        |
| `web.autoscaling.enabled`                               | Whether to enable horizontal pod autoscaling. Make sure you set `resources.requests` if you enable autoscaling. | `false`     |
| `web.autoscaling.minReplicas`                           | The minimum number of pod replicas to allow.                                                                    | `1`         |
| `web.autoscaling.maxReplicas`                           | The maximum number of pod replicas to allow.                                                                    | `100`       |
| `web.autoscaling.targetCPUUtilizationPercentage`        | The target CPU utilization percentage to aim for.                                                               | `80`        |
| `web.autoscaling.targetMemoryUtilizationPercentage`     | The target memory utilization percentage to aim for.                                                            | `80`        |


### Sidekiq parameters

| Name                                                        | Description                                                                                                     | Value     |
| ----------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------- | --------- |
| `sidekiq.replicaCount`                                      | The number of replicas to deploy.                                                                               | `1`       |
| `sidekiq.podSecurityContext.enabled`                        | Enabled Sidekiq pods' security context                                                                          | `true`    |
| `sidekiq.podSecurityContext.runAsUser`                      | Set Sidekiq pod's security context runAsUser                                                                    | `991`     |
| `sidekiq.podSecurityContext.runAsGroup`                     | Set Sidekiq pod's security context runAsGroup                                                                   | `991`     |
| `sidekiq.podSecurityContext.fsGroup`                        | Set Sidekiq pod's security context fsGroup                                                                      | `991`     |
| `sidekiq.containerSecurityContext.enabled`                  | Enabled Sidekiq containers' security context                                                                    | `false`   |
| `sidekiq.containerSecurityContext.runAsUser`                | Set Sidekiq containers' security context runAsUser                                                              | `1001`    |
| `sidekiq.containerSecurityContext.allowPrivilegeEscalation` | Set Sidekiq containers' security context allowPrivilegeEscalation                                               | `false`   |
| `sidekiq.containerSecurityContext.capabilities.drop`        | Set Sidekiq containers' security context capabilities to be dropped                                             | `["all"]` |
| `sidekiq.containerSecurityContext.readOnlyRootFilesystem`   | Set Sidekiq containers' security context readOnlyRootFilesystem                                                 | `false`   |
| `sidekiq.containerSecurityContext.runAsNonRoot`             | Set Sidekiq container's security context runAsNonRoot                                                           | `true`    |
| `sidekiq.affinity`                                          | Affinity for Sidekiq pods assignment                                                                            | `{}`      |
| `sidekiq.nodeSelector`                                      | Node labels for Sidekiq pods assignment                                                                         | `{}`      |
| `sidekiq.tolerations`                                       | Tolerations for Sidekiq pods assignment                                                                         | `[]`      |
| `sidekiq.resources.limits`                                  | The resources limits for the Sidekiq containers                                                                 | `{}`      |
| `sidekiq.resources.requests`                                | The requested resources for the Sidekiq containers                                                              | `{}`      |
| `sidekiq.autoscaling.enabled`                               | Whether to enable horizontal pod autoscaling. Make sure you set `resources.requests` if you enable autoscaling. | `false`   |
| `sidekiq.autoscaling.minReplicas`                           | The minimum number of pod replicas to allow.                                                                    | `1`       |
| `sidekiq.autoscaling.maxReplicas`                           | The maximum number of pod replicas to allow.                                                                    | `100`     |
| `sidekiq.autoscaling.targetCPUUtilizationPercentage`        | The target CPU utilization percentage to aim for.                                                               | `80`      |
| `sidekiq.autoscaling.targetMemoryUtilizationPercentage`     | The target memory utilization percentage to aim for.                                                            | `80`      |


### Streaming parameters

| Name                                                          | Description                                                                                                     | Value       |
| ------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------- | ----------- |
| `streaming.replicaCount`                                      | The number of replicas to deploy.                                                                               | `1`         |
| `streaming.service.type`                                      | The service type to create.                                                                                     | `ClusterIP` |
| `streaming.service.port`                                      | The service port to use.                                                                                        | `4000`      |
| `streaming.ingress.enabled`                                   | Enable ingress record generation for Mastodon streaming.                                                        | `false`     |
| `streaming.ingress.annotations`                               | Mapped annotations for the streaming ingress.                                                                   | `{}`        |
| `streaming.ingress.hosts`                                     | Array style hosts for the streaming ingress.                                                                    | `[]`        |
| `streaming.ingress.tls`                                       | Array style TLS secrets for the streaming ingress.                                                              | `[]`        |
| `streaming.podSecurityContext.enabled`                        | Enabled Streaming pods' security context                                                                        | `true`      |
| `streaming.podSecurityContext.runAsUser`                      | Set Streaming pod's security context runAsUser                                                                  | `991`       |
| `streaming.podSecurityContext.runAsGroup`                     | Set Streaming pod's security context runAsGroup                                                                 | `991`       |
| `streaming.podSecurityContext.fsGroup`                        | Set Streaming pod's security context fsGroup                                                                    | `991`       |
| `streaming.containerSecurityContext.enabled`                  | Enabled Streaming containers' security context                                                                  | `false`     |
| `streaming.containerSecurityContext.runAsUser`                | Set Streaming containers' security context runAsUser                                                            | `1001`      |
| `streaming.containerSecurityContext.allowPrivilegeEscalation` | Set Streaming containers' security context allowPrivilegeEscalation                                             | `false`     |
| `streaming.containerSecurityContext.capabilities.drop`        | Set Streaming containers' security context capabilities to be dropped                                           | `["all"]`   |
| `streaming.containerSecurityContext.readOnlyRootFilesystem`   | Set Streaming containers' security context readOnlyRootFilesystem                                               | `false`     |
| `streaming.containerSecurityContext.runAsNonRoot`             | Set Streaming container's security context runAsNonRoot                                                         | `true`      |
| `streaming.affinity`                                          | Affinity for Streaming pods assignment                                                                          | `{}`        |
| `streaming.nodeSelector`                                      | Node labels for Streaming pods assignment                                                                       | `{}`        |
| `streaming.tolerations`                                       | Tolerations for Streaming pods assignment                                                                       | `[]`        |
| `streaming.resources.limits`                                  | The resources limits for the streaming containers                                                               | `{}`        |
| `streaming.resources.requests`                                | The requested resources for the streaming containers                                                            | `{}`        |
| `streaming.autoscaling.enabled`                               | Whether to enable horizontal pod autoscaling. Make sure you set `resources.requests` if you enable autoscaling. | `false`     |
| `streaming.autoscaling.minReplicas`                           | The minimum number of pod replicas to allow.                                                                    | `1`         |
| `streaming.autoscaling.maxReplicas`                           | The maximum number of pod replicas to allow.                                                                    | `100`       |
| `streaming.autoscaling.targetCPUUtilizationPercentage`        | The target CPU utilization percentage to aim for.                                                               | `80`        |
| `streaming.autoscaling.targetMemoryUtilizationPercentage`     | The target memory utilization percentage to aim for.                                                            | `80`        |


### Persistence parameters

| Name                                   | Description                                                                                                                                                                                              | Value               |
| -------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------- |
| `persistence.assets.enabled`           | Enable persistence using Persistent Volume Claims.                                                                                                                                                       | `false`             |
| `persistence.assets.storageClass`      | Persistent Volume storage class.                                                                                                                                                                         | `""`                |
| `persistence.assets.size`              | Persistent Volume size.                                                                                                                                                                                  | `10Gi`              |
| `persistence.assets.existingClaim`     | The name of an existing PVC to use for persistence.                                                                                                                                                      | `""`                |
| `persistence.assets.accessModes`       | Persistent Volume access modes.                                                                                                                                                                          | `["ReadWriteOnce"]` |
| `persistence.assets.annotations`       | Persistent Volume Claim annotations.                                                                                                                                                                     | `{}`                |
| `persistence.system.enabled`           | Enable persistence using Persistent Volume Claims.                                                                                                                                                       | `false`             |
| `persistence.system.storageClass`      | Persistent Volume storage class.                                                                                                                                                                         | `""`                |
| `persistence.system.size`              | Persistent Volume size.                                                                                                                                                                                  | `50Gi`              |
| `persistence.system.existingClaim`     | The name of an existing PVC to use for persistence.                                                                                                                                                      | `""`                |
| `persistence.system.accessModes`       | Persistent Volume access modes.                                                                                                                                                                          | `["ReadWriteOnce"]` |
| `persistence.system.annotations`       | Persistent Volume Claim annotations.                                                                                                                                                                     | `{}`                |
| `job.databaseMigration.annotations`    | PostgreSQL Database Migration job annotations. Allows for additional annotations for the job, useful in GitOps scenarios like ArgoCD Helm deployments.                                                   | `{}`                |
| `job.databaseMigration.podAnnotations` | PostgreSQL Database Migration job pod annotations. Allows for additional annotations for the job pod, for example useful for disabling sidecar injections from service mesh tools like Istio or Linkerd. | `{}`                |
| `job.assetsPrecompile.annotations`     | Mastodon Assets precompile job annotations.                                                                                                                                                              | `{}`                |
| `job.assetsPrecompile.podAnnotations`  | Mastodon Assets precompile job pod annotations.                                                                                                                                                          | `{}`                |
| `job.chewyUpgrade.annotations`         | Elasticsearch Chewy Upgrade job annotations.                                                                                                                                                             | `{}`                |
| `job.chewyUpgrade.podAnnotations`      | Elasticsearch Chewy Upgrade job pod annotations.                                                                                                                                                         | `{}`                |
| `job.cron.mediaRemoval.enabled`        | Whether to enable the media removal cronjob.                                                                                                                                                             | `true`              |
| `job.cron.mediaRemoval.schedule`       | The interval of the media removal cronjob. Default is 1 week.                                                                                                                                            | `0 0 * * 0`         |
| `job.cron.podAnnotations`              | Mastodon media removal cronjob pod annotations.                                                                                                                                                          | `{}`                |


### Configuration parameters

| Name                                                       | Description                                                                                                                                                                                                                                                  | Value                                                                     |
| ---------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------- |
| `config.locale`                                            | The instance locale. Available locales can be seen [here](https://github.com/mastodon/mastodon/blob/main/config/application.rb#L71).                                                                                                                         | `en`                                                                      |
| `config.localDomain`                                       | The root domain for the instance. For example, `instance.com`.                                                                                                                                                                                               | `mastodon.localdomain`                                                    |
| `config.webDomain`                                         | If set, needs to be the subdomain of the local domain. For example, `mastodon.instance.com`. More information can be found [here](https://docs.joinmastodon.org/admin/config/#federation). Don't forget to check the proxy redirection requirements as well. | `""`                                                                      |
| `config.singleUserMode`                                    | Whether to disable registrations and only use the single created account in the database.                                                                                                                                                                    | `false`                                                                   |
| `config.emailWhitelist`                                    | If set, registrations will not be possible with any e-mails except those from the specified domains. A pipe separated list.                                                                                                                                  | `""`                                                                      |
| `config.keys.secretKeyBase`                                | The secret key base, required to set up. You can generate it with `openssl rand -hex 64`. Ignored if set in an existing secret.                                                                                                                              | `""`                                                                      |
| `config.keys.otpSecret`                                    | The OTP secret, required to set up. You can generate it with `openssl rand -hex 64`. Ignored if set in an existing secret.                                                                                                                                   | `""`                                                                      |
| `config.keys.vapidPrivateKey`                              | The Vapid private key, required to set up. You can use `openssl` to generate, see example in [values.yaml](https://artifacthub.io/packages/helm/codechem/mastodon?modal=values). Ignored if set in an existing secret.                                       | `""`                                                                      |
| `config.keys.vapidPublicKey`                               | The Vapid public key, required to set up. You can use `openssl` to generate, see example in [values.yaml](https://artifacthub.io/packages/helm/codechem/mastodon?modal=values). Ignored if set in an existing secret.                                        | `""`                                                                      |
| `config.keys.existingSecret`                               | The name of an existing secret.                                                                                                                                                                                                                              | `""`                                                                      |
| `config.keys.secretKeys.secretKeyBaseKey`                  | The secret key base key to use from an existing secret.                                                                                                                                                                                                      | `""`                                                                      |
| `config.keys.secretKeys.otpSecretKey`                      | The otp secret key to use from an existing secret.                                                                                                                                                                                                           | `""`                                                                      |
| `config.keys.secretKeys.vapidPrivateKey`                   | The Vapid private key to use from an existing secret.                                                                                                                                                                                                        | `""`                                                                      |
| `config.keys.secretKeys.vapidPublicKey`                    | The Vapid public key to use from an existing secret.                                                                                                                                                                                                         | `""`                                                                      |
| `config.initialAdmin.enabled`                              | Whether to create an initial admin user. The password is autogenerated, so you need to manually reset it with `kubectl exec -it deployment/mastodon-web -- tootctl accounts modify <USERNAME> --reset-password`.                                             | `false`                                                                   |
| `config.initialAdmin.username`                             | The username for the initial admin user. The username `admin` is reserved.                                                                                                                                                                                   | `""`                                                                      |
| `config.initialAdmin.email`                                | The email for the initial admin user.                                                                                                                                                                                                                        | `""`                                                                      |
| `config.sidekiq.concurrency`                               | The number of threads to start with sidekiq. Also used to set the database pool to the same number as the threads.                                                                                                                                           | `25`                                                                      |
| `config.streaming.workers`                                 | Controls the number of worker processes for handling real-time updates.                                                                                                                                                                                      | `1`                                                                       |
| `config.streaming.baseURL`                                 | The base URL for the streaming service. Required if the streaming API is deployed to a different domain.                                                                                                                                                     | `""`                                                                      |
| `config.postgresql.host`                                   | The PostgreSQL host to connect to. Only used if `global.postgresqlEnabled` is `false`.                                                                                                                                                                       | `postgresql.postgresql.svc.cluster.local`                                 |
| `config.postgresql.port`                                   | The PostgreSQL host port to use. Only used if `global.postgresqlEnabled` is `false`.                                                                                                                                                                         | `5432`                                                                    |
| `config.postgresql.database`                               | The PostgreSQL database to use.                                                                                                                                                                                                                              | `mastodon`                                                                |
| `config.postgresql.username`                               | The database username to use. Ignored if set in an existing secret.                                                                                                                                                                                          | `mastodon`                                                                |
| `config.postgresql.password`                               | The database username to use. Ignored if set in an existing secret.                                                                                                                                                                                          | `secretpassword`                                                          |
| `config.postgresql.existingSecret`                         | The name of an existing secret.                                                                                                                                                                                                                              | `""`                                                                      |
| `config.postgresql.secretKeys.usernameKey`                 | The username key to use from an existing secret.                                                                                                                                                                                                             | `""`                                                                      |
| `config.postgresql.secretKeys.passwordKey`                 | The password key to use from an existing secret.                                                                                                                                                                                                             | `""`                                                                      |
| `config.redis.host`                                        | The Redis host to connect to. Only used if `global.redisEnabled` is `false`.                                                                                                                                                                                 | `redis-master.redis.svc.cluster.local`                                    |
| `config.redis.port`                                        | The Redis host port to use. Only used if `global.redisEnabled` is `false`.                                                                                                                                                                                   | `6379`                                                                    |
| `config.elasticsearch.enabled`                             | Whether Elasticsearch is enabled. Differs from `global.elasticsearchEnabled`, which is used to confirm if you have your own elasticsearch instance, or you want to deploy one as a dependency chart.                                                         | `true`                                                                    |
| `config.elasticsearch.host`                                | The Elasticsearch host to connect to. Only used if `global.elasticsearchEnabled` is `false`.                                                                                                                                                                 | `elasticsearch-master-hl.logging.svc.cluster.local`                       |
| `config.elasticsearch.port`                                | The Elasticsearch host port to use. Only used if `global.elasticsearchEnabled` is `false`.                                                                                                                                                                   | `9200`                                                                    |
| `config.storage.type`                                      | The storage type for assets to use. Use `fs` for filesystem, and `s3` for S3.                                                                                                                                                                                | `fs`                                                                      |
| `config.storage.filesystem.assetsDirectory`                | The assets storage directory to use if you chose the filesystem storage type.                                                                                                                                                                                | `/opt/mastodon/public/assets`                                             |
| `config.storage.filesystem.systemDirectory`                | The system storage directory to use if you chose the filesystem storage type.                                                                                                                                                                                | `/opt/mastodon/public/system`                                             |
| `config.storage.s3.accessKeyID`                            | The S3 access key ID to use if you chose the S3 storage type. Ignored if set in an existing secret.                                                                                                                                                          | `""`                                                                      |
| `config.storage.s3.secretAccessKey`                        | The S3 secret access key to use if you chose the S3 storage type. Ignored if set in an existing secret.                                                                                                                                                      | `""`                                                                      |
| `config.storage.s3.region`                                 | The S3 region to use if you chose the S3 storage type.                                                                                                                                                                                                       | `""`                                                                      |
| `config.storage.s3.bucket`                                 | The name of the S3 bucket to use if you chose the S3 storage type.                                                                                                                                                                                           | `""`                                                                      |
| `config.storage.s3.endpointURI`                            | The S3 endpoint URI to use if you chose the S3 storage type.                                                                                                                                                                                                 | `""`                                                                      |
| `config.storage.s3.hostname`                               | The S3 hostname to use if you chose the S3 storage type.                                                                                                                                                                                                     | `""`                                                                      |
| `config.storage.s3.aliasHost`                              | The S3 alias host to use if you chose the S3 storage type. If you have a caching proxy, enter its base URL here.                                                                                                                                             | `""`                                                                      |
| `config.storage.s3.existingSecret`                         | The name of an existing secret.                                                                                                                                                                                                                              | `""`                                                                      |
| `config.storage.s3.secretKeys.accessKeyIDKey`              | The S3 access key ID to use from an existing secret.                                                                                                                                                                                                         | `""`                                                                      |
| `config.storage.s3.secretKeys.secretAccessKey`             | The S3 secret access key to use from an existing secret.                                                                                                                                                                                                     | `""`                                                                      |
| `config.smtp.enabled`                                      | Whether to enable SMTP configuration.                                                                                                                                                                                                                        | `false`                                                                   |
| `config.smtp.caFile`                                       | The path of the CA file to use.                                                                                                                                                                                                                              | `/etc/ssl/certs/ca-certificates.crt`                                      |
| `config.smtp.authMethod`                                   | The authentication method to use.                                                                                                                                                                                                                            | `plain`                                                                   |
| `config.smtp.deliveryMethod`                               | The delivery method to use.                                                                                                                                                                                                                                  | `smtp`                                                                    |
| `config.smtp.fromAddress`                                  | The SMTP default email to send from.                                                                                                                                                                                                                         | `mastodon@example.com`                                                    |
| `config.smtp.replyTo`                                      | The SMTP default email to reply to.                                                                                                                                                                                                                          | `mastodon@example.com`                                                    |
| `config.smtp.domain`                                       | The SMTP domain to use.                                                                                                                                                                                                                                      | `""`                                                                      |
| `config.smtp.server`                                       | The SMTP host to use.                                                                                                                                                                                                                                        | `smtp.gmail.com`                                                          |
| `config.smtp.port`                                         | The SMTP port to use.                                                                                                                                                                                                                                        | `587`                                                                     |
| `config.smtp.username`                                     | The SMTP username to use. Ignored if set in an existing secret.                                                                                                                                                                                              | `""`                                                                      |
| `config.smtp.password`                                     | The SMTP password to use. Ignored if set in an existing secret.                                                                                                                                                                                              | `""`                                                                      |
| `config.smtp.enableStartTLS`                               | The enable start TLS strategy to use.                                                                                                                                                                                                                        | `auto`                                                                    |
| `config.smtp.openSSLVerifyMode`                            | The openssl verify mode to use.                                                                                                                                                                                                                              | `peer`                                                                    |
| `config.smtp.tls`                                          | Whether to use TLS for the SMTP connection.                                                                                                                                                                                                                  | `false`                                                                   |
| `config.smtp.existingSecret`                               | The name of an existing secret.                                                                                                                                                                                                                              | `""`                                                                      |
| `config.smtp.secretKeys.usernameKey`                       | The SMTP username to use from an existing secret.                                                                                                                                                                                                            | `""`                                                                      |
| `config.smtp.secretKeys.passwordKey`                       | The SMTP password to use from an existing secret.                                                                                                                                                                                                            | `""`                                                                      |
| `config.metrics.statsd.address`                            | The statsd address to publish Mastodon metrics to.                                                                                                                                                                                                           | `""`                                                                      |
| `config.providers.oidc.enabled`                            | Whether to enable OIDC configuration.                                                                                                                                                                                                                        | `false`                                                                   |
| `config.providers.oidc.displayName`                        | The Open ID Connect display name.                                                                                                                                                                                                                            | `example-label`                                                           |
| `config.providers.oidc.issuer`                             | The Open ID Connect issuer.                                                                                                                                                                                                                                  | `https://login.example.space/auth/realms/example-space`                   |
| `config.providers.oidc.discovery`                          | Whether to enable discovery for Open ID Connect.                                                                                                                                                                                                             | `true`                                                                    |
| `config.providers.oidc.scope`                              | The Open ID Connect scopes, comma separated.                                                                                                                                                                                                                 | `openid,profile`                                                          |
| `config.providers.oidc.uidField`                           | The Open ID Connect UID field.                                                                                                                                                                                                                               | `uid`                                                                     |
| `config.providers.oidc.clientID`                           | The Open ID Connect client ID. Ignored if set in an existing secret.                                                                                                                                                                                         | `""`                                                                      |
| `config.providers.oidc.clientSecret`                       | The Open ID Connect client secret. Ignored if set in an existing secret.                                                                                                                                                                                     | `""`                                                                      |
| `config.providers.oidc.redirectURI`                        | The Open ID Connect redirection URI.                                                                                                                                                                                                                         | `https://example.com/auth/auth/openid_connect/callback`                   |
| `config.providers.oidc.assumeEmailVerified`                | Whether to assume that the email is verified for Open ID Connect.                                                                                                                                                                                            | `true`                                                                    |
| `config.providers.oidc.clientAuthMethod`                   | The Open ID Connect client auth method.                                                                                                                                                                                                                      | `basic`                                                                   |
| `config.providers.oidc.responseType`                       | The Open ID Connect response type.                                                                                                                                                                                                                           | `code`                                                                    |
| `config.providers.oidc.responseMode`                       | The Open ID Connect response mode.                                                                                                                                                                                                                           | `query`                                                                   |
| `config.providers.oidc.display`                            | The Open ID Connect display type.                                                                                                                                                                                                                            | `page`                                                                    |
| `config.providers.oidc.prompt`                             | The Open ID Connect prompt type.                                                                                                                                                                                                                             | `""`                                                                      |
| `config.providers.oidc.sendNonce`                          | Whether to enable send nonce for Open ID Connect.                                                                                                                                                                                                            | `true`                                                                    |
| `config.providers.oidc.sendScopeToTokenEndpoint`           | Whether to enable sending scope to token endpoint for Open ID Connect.                                                                                                                                                                                       | `true`                                                                    |
| `config.providers.oidc.idpLogoutRedirectURI`               | The Open ID Connect IDP logout redirect URI.                                                                                                                                                                                                                 | `""`                                                                      |
| `config.providers.oidc.httpScheme`                         | The Open ID Connect HTTP scheme.                                                                                                                                                                                                                             | `""`                                                                      |
| `config.providers.oidc.host`                               | The Open ID Connect host.                                                                                                                                                                                                                                    | `""`                                                                      |
| `config.providers.oidc.port`                               | The Open ID Connect port.                                                                                                                                                                                                                                    | `""`                                                                      |
| `config.providers.oidc.jwksURI`                            | The Open ID Connect JWKs URI.                                                                                                                                                                                                                                | `""`                                                                      |
| `config.providers.oidc.authEndpoint`                       | The Open ID Connect auth endpoint.                                                                                                                                                                                                                           | `""`                                                                      |
| `config.providers.oidc.tokenEndpoint`                      | The Open ID Connect token endpoint.                                                                                                                                                                                                                          | `""`                                                                      |
| `config.providers.oidc.userInfoEndpoint`                   | The Open ID Connect user information endpoint.                                                                                                                                                                                                               | `""`                                                                      |
| `config.providers.oidc.endSessionEndpoint`                 | The Open ID Connect end session endpoint.                                                                                                                                                                                                                    | `""`                                                                      |
| `config.providers.saml.enabled`                            | Whether to enable SAML configuration.                                                                                                                                                                                                                        | `false`                                                                   |
| `config.providers.saml.acsURL`                             | The SAML access URL.                                                                                                                                                                                                                                         | `http://mastodon.example.com/auth/auth/saml/callback`                     |
| `config.providers.saml.issuer`                             | The SAML issuer.                                                                                                                                                                                                                                             | `mastodon`                                                                |
| `config.providers.saml.idpSsoTargetURL`                    | The SAML IDP SSO target URL.                                                                                                                                                                                                                                 | `https://login.example.com/auth/realms/example/protocol/saml`             |
| `config.providers.saml.idpCert`                            | The SAML IDP certificate.                                                                                                                                                                                                                                    | `-----BEGIN CERTIFICATE-----[your_cert_content]-----END CERTIFICATE-----` |
| `config.providers.saml.idpCertFingerprint`                 | The SAML IDP certificate fingerprint.                                                                                                                                                                                                                        | `""`                                                                      |
| `config.providers.saml.nameIdentifierFormat`               | The SAML name identifier format.                                                                                                                                                                                                                             | `urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified`                   |
| `config.providers.saml.cert`                               | The SAML certificate. Ignored if set in an existing secret.                                                                                                                                                                                                  | `""`                                                                      |
| `config.providers.saml.privateKey`                         | The SAML private key. Ignored if set in an existing secret.                                                                                                                                                                                                  | `""`                                                                      |
| `config.providers.saml.wantAssertionSigned`                | Whether to enable assertion signing for SAML.                                                                                                                                                                                                                | `true`                                                                    |
| `config.providers.saml.wantAssertionEncrypted`             | Whether to enable assertion encryption for SAML.                                                                                                                                                                                                             | `true`                                                                    |
| `config.providers.saml.assumeEmailVerified`                | Whether to assumme the email is verified for SAML.                                                                                                                                                                                                           | `true`                                                                    |
| `config.providers.saml.uidAttribute`                       | The SAML UID attribute.                                                                                                                                                                                                                                      | `urn:oid:0.9.2342.19200300.100.1.1`                                       |
| `config.providers.saml.attributesStatements.uid`           | The SAML attributes statements UID.                                                                                                                                                                                                                          | `urn:oid:0.9.2342.19200300.100.1.1`                                       |
| `config.providers.saml.attributesStatements.email`         | The SAML attributes statements email.                                                                                                                                                                                                                        | `urn:oid:1.3.6.1.4.1.5923.1.1.1.6`                                        |
| `config.providers.saml.attributesStatements.fullName`      | The SAML attributes statements full name.                                                                                                                                                                                                                    | `urn:oid:2.16.840.1.113730.3.1.241`                                       |
| `config.providers.saml.attributesStatements.firstName`     | The SAML attributes statements first name.                                                                                                                                                                                                                   | `urn:oid:2.5.4.42`                                                        |
| `config.providers.saml.attributesStatements.lastName`      | The SAML attributes statements last name.                                                                                                                                                                                                                    | `urn:oid:2.5.4.4`                                                         |
| `config.providers.saml.attributesStatements.verified`      | Whether the attribute statements should be verified for SAML.                                                                                                                                                                                                | `true`                                                                    |
| `config.providers.saml.attributesStatements.verifiedEmail` | The SAML attributes statements verified email.                                                                                                                                                                                                               | `""`                                                                      |
| `config.providers.cas.enabled`                             | Whether to enable CAS configuration.                                                                                                                                                                                                                         | `false`                                                                   |
| `config.providers.cas.oauthRedirectAtSignIn`               | Whether to force redirect local login to CAS.                                                                                                                                                                                                                | `false`                                                                   |
| `config.providers.cas.url`                                 | The CAS provider URL.                                                                                                                                                                                                                                        | `https://sso.myserver.com`                                                |
| `config.providers.cas.host`                                | The CAS provider host.                                                                                                                                                                                                                                       | `sso.myserver.com`                                                        |
| `config.providers.cas.port`                                | The CAS provider port.                                                                                                                                                                                                                                       | `443`                                                                     |
| `config.providers.cas.ssl`                                 | Whether to enable SSL for the CAS provider.                                                                                                                                                                                                                  | `true`                                                                    |
| `config.providers.cas.validateURL`                         | The CAS provider validation URL.                                                                                                                                                                                                                             | `""`                                                                      |
| `config.providers.cas.callbackURL`                         | The CAS provider callback URL.                                                                                                                                                                                                                               | `""`                                                                      |
| `config.providers.cas.logoutURL`                           | The CAS provider logout URL.                                                                                                                                                                                                                                 | `""`                                                                      |
| `config.providers.cas.loginURL`                            | The CAS provider login URL.                                                                                                                                                                                                                                  | `""`                                                                      |
| `config.providers.cas.uidField`                            | The CAS provider UID field.                                                                                                                                                                                                                                  | `user`                                                                    |
| `config.providers.cas.caPath`                              | The CAS provider CA path.                                                                                                                                                                                                                                    | `""`                                                                      |
| `config.providers.cas.disableSslVerification`              | Whether to disable SSL verification for the CAS provider.                                                                                                                                                                                                    | `false`                                                                   |
| `config.providers.cas.assumeEmailVerified`                 | Whether to assume email is verified for the CAS provider.                                                                                                                                                                                                    | `true`                                                                    |
| `config.providers.cas.keys.uid`                            | The CAS provider UID key.                                                                                                                                                                                                                                    | `user`                                                                    |
| `config.providers.cas.keys.name`                           | The CAS provider name key.                                                                                                                                                                                                                                   | `name`                                                                    |
| `config.providers.cas.keys.email`                          | The CAS provider email key.                                                                                                                                                                                                                                  | `email`                                                                   |
| `config.providers.cas.keys.nickname`                       | The CAS provider nickname key.                                                                                                                                                                                                                               | `nickname`                                                                |
| `config.providers.cas.keys.firstName`                      | The CAS provider first name key.                                                                                                                                                                                                                             | `firstname`                                                               |
| `config.providers.cas.keys.lastName`                       | The CAS provider last name key.                                                                                                                                                                                                                              | `lastname`                                                                |
| `config.providers.cas.keys.location`                       | The CAS provider location key.                                                                                                                                                                                                                               | `location`                                                                |
| `config.providers.cas.keys.image`                          | The CAS provider image key.                                                                                                                                                                                                                                  | `image`                                                                   |
| `config.providers.cas.keys.phone`                          | The CAS provider phone key.                                                                                                                                                                                                                                  | `phone`                                                                   |
| `config.providers.pam.enabled`                             | Whether to enable PAM configuration.                                                                                                                                                                                                                         | `false`                                                                   |
| `config.providers.pam.emailDomain`                         | The PAM provider email domain.                                                                                                                                                                                                                               | `example.com`                                                             |
| `config.providers.pam.defaultService`                      | The PAM provider default service.                                                                                                                                                                                                                            | `rpam`                                                                    |
| `config.providers.pam.controlledService`                   | The PAM provider controlled service.                                                                                                                                                                                                                         | `rpam`                                                                    |
| `config.providers.ldap.enabled`                            | Whether to enable LDAP configuration.                                                                                                                                                                                                                        | `false`                                                                   |
| `config.providers.ldap.host`                               | The LDAP host to use.                                                                                                                                                                                                                                        | `myservice.namespace.svc`                                                 |
| `config.providers.ldap.port`                               | The LDAP port to use.                                                                                                                                                                                                                                        | `389`                                                                     |
| `config.providers.ldap.method`                             | The LDAP method to use.                                                                                                                                                                                                                                      | `simple_tls`                                                              |
| `config.providers.ldap.base`                               | The LDAP base to use.                                                                                                                                                                                                                                        | `""`                                                                      |
| `config.providers.ldap.bindOn`                             | The LDAP bind to use.                                                                                                                                                                                                                                        | `""`                                                                      |
| `config.providers.ldap.password`                           | The LDAP password to use. Ignored if set in an existing secret.                                                                                                                                                                                              | `""`                                                                      |
| `config.providers.ldap.uid`                                | The LDAP UID to use.                                                                                                                                                                                                                                         | `cn`                                                                      |
| `config.providers.ldap.mail`                               | The LDAP mail to use.                                                                                                                                                                                                                                        | `mail`                                                                    |
| `config.providers.ldap.searchFilter`                       | The LDAP search filter to use                                                                                                                                                                                                                                | `(|(%{uid}=%{email})(%{mail}=%{email}))`                                  |
| `config.providers.ldap.uidConversion.enabled`              | Whether to enable UID conversion.                                                                                                                                                                                                                            | `true`                                                                    |
| `config.providers.ldap.uidConversion.search`               | The UID conversion search pattern for LDAP.                                                                                                                                                                                                                  | `., -`                                                                    |
| `config.providers.ldap.uidConversion.replace`              | The UID conversion replace pattern for LDAP.                                                                                                                                                                                                                 | `_`                                                                       |
| `config.providers.existingSecret`                          | The name of an existing secret to use.                                                                                                                                                                                                                       | `""`                                                                      |
| `config.providers.secretKeys.oidcClientIDKey`              | The OpenID Connect client ID key to use from an existing secret.                                                                                                                                                                                             | `""`                                                                      |
| `config.providers.secretKeys.oidcClientSecretKey`          | The OpenID Connect client secret key to use from an existing secret.                                                                                                                                                                                         | `""`                                                                      |
| `config.providers.secretKeys.samlCertKey`                  | The SAML certificate key to use from an existing secret.                                                                                                                                                                                                     | `""`                                                                      |
| `config.providers.secretKeys.samlPrivateKey`               | The SAML private key to use from an existing secret.                                                                                                                                                                                                         | `""`                                                                      |
| `config.providers.secretKeys.ldapPasswordKey`              | The LDAP password key to use from an existing secret.                                                                                                                                                                                                        | `""`                                                                      |


### Elasticsearch configuration (Check for [more parameters here](https://artifacthub.io/packages/helm/bitnami/elasticsearch))

| Name                                      | Description                                               | Value |
| ----------------------------------------- | --------------------------------------------------------- | ----- |
| `elasticsearch.image.tag`                 | Elasticsearch image tag (immutable tags are recommended). | `7`   |
| `elasticsearch.master.replicaCount`       | Number of master-elegible replicas to deploy.             | `1`   |
| `elasticsearch.data.replicaCount`         | Number of data-only replicas to deploy.                   | `1`   |
| `elasticsearch.coordinating.replicaCount` | Number of coordinating-only replicas to deploy.           | `1`   |
| `elasticsearch.ingest.replicaCount`       | Number of ingest-only replicas to deploy.                 | `1`   |


### PostgreSQL configuration (Check for [more parameters here](https://artifacthub.io/packages/helm/bitnami/postgresql))

| Name                                          | Description                                                                                      | Value                 |
| --------------------------------------------- | ------------------------------------------------------------------------------------------------ | --------------------- |
| `postgresql.auth.database`                    | Name for a custom database to create.                                                            | `mastodon`            |
| `postgresql.auth.username`                    | Name for a custom user to create.                                                                | `mastodon`            |
| `postgresql.auth.password`                    | Password for the custom user to create.                                                          | `secretpassword`      |
| `postgresql.auth.postgresPassword`            | Password for the `postgres` admin user.                                                          | `supersecretpassword` |
| `postgresql.auth.existingSecret`              | Existing secret containing the passwords for the `postgres` and the regular user. Must set both. | `""`                  |
| `postgresql.auth.secretKeys.adminPasswordKey` | Existing password key in a secret for the `postgres` admin user.                                 | `""`                  |
| `postgresql.auth.secretKeys.userPasswordKey`  | Existing password key in a secret for the regular user you set up in the config section.         | `""`                  |


### Redis configuration (Check for [more parameters here](https://artifacthub.io/packages/helm/bitnami/redis))

| Name                         | Description                                | Value   |
| ---------------------------- | ------------------------------------------ | ------- |
| `redis.auth.enabled`         | Whether to enable password authentication. | `false` |
| `redis.replica.replicaCount` | Number of Redis replicas to deploy.        | `1`     |


Specify each parameter using the `--set key=value[,key=value]` argument to `helm install`. For example,

```console
helm install example \
  --set user=example \
  --set password=example \
    codechem/example
```

Alternatively, a YAML file that specifies the values for the above parameters can be provided while installing the chart. For example,

```console
helm install example -f values.yaml codechem/example
```

> **Tip**: You can use the default [values.yaml](values.yaml)

## Configuration and installation details

## GitOps (ArgoCD) configuration

The helm hooks configured in the job manifests will break deployments in situations where GitOps tools like ArgoCD are used. To make sure the deployment works, you need to set the additional hook annotations in the `values.yaml` file. For ArgoCD, this means that the [resource hooks](https://argo-cd.readthedocs.io/en/stable/user-guide/resource_hooks/#usage) need to be used, in this case, the `Sync` hook, which according to the docs, executes after all `PreSync` hooks are completed and were successful, at the same time as the application of the manifests. This allows the resources to be synchronized first, and then the original helm hooks will be respected. Without this, ArgoCD will run the `db-migrate` job without deploying its dependencies, like the persistent volume claim.

For example, you can set the following in the `values.yaml` configuration:

```yaml
job:
  databaseMigration:
    annotations:
      "argocd.argoproj.io/hook": Sync
      "argocd.argoproj.io/sync-wave": "0"
      "argocd.argoproj.io/hook-delete-policy": BeforeHookCreation,HookSucceeded
```

## Replacing the initial admin password

If you've opted for creating an initial admin, you can run the [admin CLI](https://docs.joinmastodon.org/admin/tootctl/) commands in the web deployment.

```bash
kubectl exec -it deployment/mastodon-web -- bash
tootctl accounts modify admin --reset-password
```

or, in one line:

```bash
kubectl exec -it deployment/mastodon-web -- tootctl accounts modify admin --reset-password
```

## License

Copyright &copy; 2022 CodeChem

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
